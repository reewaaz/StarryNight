<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StellarNav - Sky Viewer</title>
    
    <!-- Astronomy Engine (Calculates Planet Positions) -->
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: sans-serif; color: white; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* UI Layer */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            z-index: 10;
        }

        /* Top Bar */
        #top-bar {
            padding: 15px; pointer-events: auto;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; gap: 10px;
        }
        #search-box {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 10px; border-radius: 20px; flex-grow: 1;
            backdrop-filter: blur(5px); outline: none;
        }

        /* Center Reticle */
        #reticle {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px; transform: translate(-50%, -50%);
            border: 2px solid rgba(0, 255, 255, 0.5); border-radius: 50%;
        }
        #reticle::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: cyan; transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* Info Panel */
        #info-panel {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            background: rgba(20, 30, 40, 0.85); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto;
        }
        #obj-name { margin: 0; color: #4db8ff; font-size: 1.5rem; }
        #obj-data { color: #ccc; font-size: 0.9rem; margin-top: 5px; font-family: monospace; }
        #guide-msg { color: #ffeb3b; font-style: italic; margin-top: 5px; font-size: 0.9rem; display: none; }

        /* Start / Permission Overlay */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        #start-btn {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            border: none; color: white; padding: 15px 50px; font-size: 1.2rem;
            border-radius: 30px; margin-top: 20px; cursor: pointer;
            box-shadow: 0 0 25px rgba(0, 114, 255, 0.6);
        }

        /* Debug Console (Hidden by default, shows on error) */
        #debug-console {
            position: absolute; top: 60px; left: 10px; right: 10px; height: 100px;
            background: rgba(255,0,0,0.2); color: #ffaaaa; font-family: monospace;
            font-size: 10px; overflow-y: scroll; pointer-events: none;
            display: none; border: 1px solid red; z-index: 5;
        }
    </style>

    <!-- Import Maps for Three.js Modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="debug-console"></div>

    <div id="start-overlay">
        <h1>StellarNav</h1>
        <p style="color: #aaa; margin-bottom: 30px;">
            Real-time AR Sky Viewer.<br>
            <small>Requires HTTPS & GPS</small>
        </p>
        <button id="start-btn">Start Exploring</button>
        <p id="status-msg" style="margin-top: 20px; font-size: 0.8rem; color: #666;">Ready.</p>
    </div>

    <div id="ui-layer">
        <div id="top-bar">
            <input type="text" id="search-box" placeholder="Search (e.g. Mars, Moon)...">
        </div>
        <div id="reticle"></div>
        <div id="info-panel">
            <h2 id="obj-name">Point to Sky</h2>
            <div id="obj-data">Waiting for sensors...</div>
            <div id="guide-msg"></div>
        </div>
    </div>

    <!-- Error Handler Script (Non-Module to catch module errors) -->
    <script>
        const consoleDiv = document.getElementById('debug-console');
        const statusMsg = document.getElementById('status-msg');
        
        function log(msg, isError = false) {
            console.log(msg);
            if(isError) {
                consoleDiv.style.display = 'block';
                consoleDiv.innerHTML += `<div style="color: ${isError ? '#ff5555' : '#fff'}">${msg}</div>`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                statusMsg.innerText = msg;
                statusMsg.style.color = 'red';
            } else {
                statusMsg.innerText = msg;
            }
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`Error: ${message}`, true);
        };

        // Protocol Check
        if(window.location.protocol === 'file:') {
            log("CRITICAL: App cannot run via file:// protocol. Please use a local server or GitHub Pages.", true);
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').style.opacity = 0.5;
            document.getElementById('start-btn').innerText = "Run on Server required";
        }
    </script>

    <!-- Main App Logic -->
    <script type="module">
        import * as THREE from 'three';
        import { DeviceOrientationControls } from 'three/addons/controls/DeviceOrientationControls.js';

        // --- Variables ---
        let scene, camera, renderer, controls;
        let starField, guideArrow;
        const celestialObjects = [];
        const bodies = [
            { name: 'Sun', body: Astronomy.Body.Sun, color: 0xFFD700, size: 20 },
            { name: 'Moon', body: Astronomy.Body.Moon, color: 0xDDDDDD, size: 15 },
            { name: 'Mercury', body: Astronomy.Body.Mercury, color: 0xAAAAAA, size: 4 },
            { name: 'Venus', body: Astronomy.Body.Venus, color: 0xE3BB76, size: 8 },
            { name: 'Mars', body: Astronomy.Body.Mars, color: 0xFF4500, size: 6 },
            { name: 'Jupiter', body: Astronomy.Body.Jupiter, color: 0xD9A066, size: 12 },
            { name: 'Saturn', body: Astronomy.Body.Saturn, color: 0xF4D03F, size: 10 },
            { name: 'Uranus', body: Astronomy.Body.Uranus, color: 0x4FD0E7, size: 8 },
            { name: 'Neptune', body: Astronomy.Body.Neptune, color: 0x4169E1, size: 8 }
        ];

        let userLoc = { lat: 0, lon: 0 };
        let raycaster, center;
        let isRunning = false;
        let selectedObj = null;

        // UI Elements
        const btn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');
        const uiName = document.getElementById('obj-name');
        const uiData = document.getElementById('obj-data');
        const uiGuide = document.getElementById('guide-msg');
        const searchInput = document.getElementById('search-box');

        // --- Init Function ---
        function init() {
            log("Initializing 3D Engine...");
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));

            // Helpers
            const grid = new THREE.PolarGridHelper(1000, 16, 8, 64, 0x222222, 0x111111);
            grid.position.y = -10;
            scene.add(grid);

            // Objects
            createStars();
            createGuideArrow();
            
            // Raycaster
            raycaster = new THREE.Raycaster();
            center = new THREE.Vector2(0,0);

            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Start Loop
            renderer.setAnimationLoop(animate);
            log("Ready to Start.");
        }

        // --- App Logic ---

        function createStars() {
            const geom = new THREE.BufferGeometry();
            const pos = [];
            const col = [];
            for(let i=0; i<3000; i++) {
                const r = 1000 + Math.random()*500;
                const theta = 2 * Math.PI * Math.random();
                const phi = Math.acos(2 * Math.random() - 1);
                pos.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                col.push(0.9, 0.9, 1);
            }
            geom.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({ size: 3, vertexColors: true, transparent: true, opacity: 0.8 });
            starField = new THREE.Points(geom, mat);
            scene.add(starField);
        }

        function createGuideArrow() {
            // Arrow attached to camera for HUD-like guidance
            const geom = new THREE.ConeGeometry(1, 5, 4);
            geom.rotateX(Math.PI/2);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true, opacity: 0.5 });
            guideArrow = new THREE.Mesh(geom, mat);
            guideArrow.position.z = -15; // In front of camera
            guideArrow.visible = false;
            camera.add(guideArrow);
            scene.add(camera);
        }

        function updatePositions() {
            if(!userLoc.lat) return;
            const date = new Date();
            const observer = new Astronomy.Observer(userLoc.lat, userLoc.lon, 0);

            bodies.forEach(b => {
                const equ = Astronomy.Equator(b.body, date, observer, false, true);
                const hor = Astronomy.Horizon(date, observer, equ.ra, equ.dec, 'normal');

                // Convert Az/Alt to 3D. 
                // Az=0 (N), Az=90 (E), Az=180 (S), Az=270 (W)
                // Alt=0 (Horizon), Alt=90 (Up)
                // ThreeJS: Y is Up. Z is usually South in default cam, but we calibrate later.
                
                const r = 800;
                const phi = (90 - hor.altitude) * Math.PI / 180;
                const theta = -hor.azimuth * Math.PI / 180; // Negative to match rotation direction

                // Standard conversion (Y-up)
                const x = r * Math.sin(theta) * Math.sin(phi);
                const y = r * Math.cos(phi);
                const z = r * Math.cos(theta) * Math.sin(phi);

                let mesh = celestialObjects.find(o => o.userData.name === b.name);
                if(!mesh) {
                    mesh = new THREE.Mesh(
                        new THREE.SphereGeometry(b.size, 16, 16),
                        new THREE.MeshBasicMaterial({ color: b.color })
                    );
                    mesh.userData = { name: b.name, az: 0, alt: 0 };
                    scene.add(mesh);
                    celestialObjects.push(mesh);
                    
                    // Simple Text Sprite
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    cvs.width = 128; cvs.height = 64;
                    ctx.fillStyle = 'white'; ctx.font = '20px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText(b.name, 64, 40);
                    const tex = new THREE.CanvasTexture(cvs);
                    const spr = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
                    spr.scale.set(10,5,1);
                    spr.position.y = b.size + 2;
                    mesh.add(spr);
                }

                mesh.position.set(x, y, z);
                mesh.lookAt(camera.position); // Billboard effect
                mesh.userData.az = hor.azimuth;
                mesh.userData.alt = hor.altitude;
            });
        }

        // --- Interaction ---

        btn.addEventListener('click', async () => {
            log("Start clicked...");
            btn.disabled = true;
            btn.innerText = "Locating...";

            try {
                // 1. Get GPS
                log("Requesting GPS...");
                await new Promise((resolve, reject) => {
                    if(!navigator.geolocation) return reject("Geo API not supported");
                    navigator.geolocation.getCurrentPosition(
                        (pos) => { 
                            userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                            log(`GPS Locked: ${userLoc.lat.toFixed(2)}, ${userLoc.lon.toFixed(2)}`);
                            updatePositions();
                            resolve(); 
                        },
                        (err) => {
                            log("GPS Denied. Using Default (0,0).");
                            userLoc = { lat: 0, lon: 0 }; // Default
                            updatePositions();
                            resolve(); // Continue anyway
                        },
                        { enableHighAccuracy: false, timeout: 5000 }
                    );
                });

                // 2. Request Sensors (iOS 13+)
                log("Initializing Sensors...");
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') throw new Error("Sensor permission denied");
                }

                // 3. Start Controls
                controls = new DeviceOrientationControls(camera);
                controls.alphaOffset = 0; // Calibration offset if needed
                
                // Hide Overlay
                overlay.style.display = 'none';
                isRunning = true;
                log("Running.", false);

            } catch (e) {
                log(e.message, true);
                btn.disabled = false;
                btn.innerText = "Retry";
            }
        });

        // Search Logic
        searchInput.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const found = celestialObjects.find(o => o.userData.name.toLowerCase().includes(q));
            
            if(found && q.length > 0) {
                selectedObj = found;
                guideArrow.visible = true;
                uiGuide.style.display = 'block';
                uiGuide.innerText = `Turn to ${found.userData.name}`;
            } else {
                selectedObj = null;
                guideArrow.visible = false;
                uiGuide.style.display = 'none';
            }
        });

        // --- Animation ---
        function animate() {
            if(controls) controls.update();

            // Raycast for center object
            raycaster.setFromCamera(center, camera);
            const intersects = raycaster.intersectObjects(celestialObjects);
            
            if(intersects.length > 0) {
                const o = intersects[0].object;
                uiName.innerText = o.userData.name;
                uiData.innerText = `Az: ${o.userData.az.toFixed(1)}° Alt: ${o.userData.alt.toFixed(1)}°`;
            } else {
                uiName.innerText = "Sky View";
                uiData.innerText = isRunning ? "Scanning..." : "Paused";
            }

            // Arrow Guidance
            if(selectedObj) {
                // Point arrow at object in local camera space
                camera.updateMatrixWorld();
                const localPos = selectedObj.position.clone().applyMatrix4(camera.matrixWorldInverse);
                localPos.normalize();
                
                // Simple: look at the target vector
                guideArrow.lookAt(guideArrow.position.clone().add(localPos));
                
                // Check visibility (dot product)
                const fwd = new THREE.Vector3(0,0,-1);
                if(fwd.dot(localPos) > 0.8) {
                    guideArrow.material.color.setHex(0x00ff00); // Green if in front
                } else {
                    guideArrow.material.color.setHex(0xffff00); // Yellow if searching
                }
            }

            renderer.render(scene, camera);
        }

        // Run Init
        init();

    </script>
</body>
</html>
