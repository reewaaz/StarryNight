<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Pocket Sky – Live</title>

<!-- ================== STYLE ================== -->
<style>
:root{
  --glass: rgba(255,255,255,0.12);
  --accent: #4fd1ff;
  --danger: #ff5c5c;
}
html,body{margin:0; padding:0; background:#02030a; color:white; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; overflow:hidden}
canvas{display:block}

/* Glass UI */
.glass{background:linear-gradient(180deg,rgba(255,255,255,0.18),rgba(255,255,255,0.05)); backdrop-filter: blur(12px); border:1px solid rgba(255,255,255,0.15)}

/* Start screen */
#start{position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:99; background:radial-gradient(circle at top,#0a1430,#02030a)}
#start h1{letter-spacing:4px; font-weight:300}
#start p{opacity:.7; max-width:280px; text-align:center}
#start button{margin-top:25px; padding:16px 46px; border-radius:40px; border:none; background:linear-gradient(135deg,#4fd1ff,#667bff); color:black; font-weight:700; font-size:1.05rem}

/* HUD */
#hud{position:fixed; inset:0; pointer-events:none}
#top{position:absolute; top:14px; left:14px; right:14px; display:flex; gap:12px; pointer-events:auto}
#search{flex:1; padding:14px 18px; border-radius:30px; background:var(--glass); border:1px solid rgba(255,255,255,0.2); color:white; outline:none}
#results{position:absolute; top:60px; left:14px; right:14px; max-height:220px; overflow:auto; display:none}
.result{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.1)}
.result:active{background:rgba(255,255,255,0.08)}

/* Compass */
#compass{position:absolute; bottom:24px; left:50%; transform:translateX(-50%); width:130px; height:130px; border-radius:50%; display:flex; align-items:center; justify-content:center}
#needle{width:4px; height:48px; background:linear-gradient(to top,var(--danger),white); border-radius:2px; transform-origin:50% 90%}
#cardinal{position:absolute; font-size:12px; opacity:.75}

/* Target */
#target{position:absolute; width:56px; height:56px; border:2px solid var(--accent); border-radius:50%; transform:translate(-50%,-50%); display:none}
#arrow{position:absolute; width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent; border-bottom:26px solid var(--accent); transform-origin:50% 120%; display:none}

.label{position:absolute; font-size:11px; opacity:.75; white-space:nowrap; text-shadow:0 0 4px black; pointer-events:none}
</style>
</head>
<body>

<!-- START -->
<div id="start">
  <h1>POCKET SKY</h1>
  <p>Move your phone to explore the real sky in real time.<br>Compass & location required.</p>
  <button id="go">Start</button>
</div>

<!-- HUD -->
<div id="hud">
  <div id="top">
    <input id="search" placeholder="Search stars, planets…" />
  </div>
  <div id="results" class="glass"></div>
  <div id="target"></div>
  <div id="arrow"></div>

  <div id="compass" class="glass">
    <div id="needle"></div>
    <div id="cardinal">N</div>
  </div>
</div>

<!-- ================== SCRIPT ================== -->
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

let scene,camera,renderer,sky;
let labels=[], objects=[], target=null;
let lat=0, lon=0;

/* ---------- INIT ---------- */
init();
function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x02030a);

  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,2000);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  sky=new THREE.Group(); scene.add(sky);

  createStars();
  createSunMoon();

  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

  animate();
}

/* ---------- ASTRONOMY ---------- */
function gst(){
  const d=(Date.now()-Date.UTC(2000,0,1,12))/86400000;
  return (18.697374558+24.06570982441908*d)%24;
}

function alignSky(){
  const lst=(gst()+lon/15)*15*Math.PI/180;
  sky.rotation.y=-lst;
  sky.rotation.x=THREE.MathUtils.degToRad(lat-90);
}

function vec(ra,dec,r=500){
  ra*=15*Math.PI/180; dec*=Math.PI/180;
  return new THREE.Vector3(
    -r*Math.cos(dec)*Math.sin(ra),
     r*Math.sin(dec),
    -r*Math.cos(dec)*Math.cos(ra)
  );
}

/* ---------- CONTENT ---------- */
function createStars(){
  const tex=document.createElement('canvas'); tex.width=32; tex.height=32;
  const c=tex.getContext('2d');
  const g=c.createRadialGradient(16,16,0,16,16,16);
  g.addColorStop(0,'white'); g.addColorStop(1,'transparent');
  c.fillStyle=g; c.fillRect(0,0,32,32);
  const t=new THREE.CanvasTexture(tex);

  const stars=[
    ['Sirius',6.75,-16.7,-1.46],['Canopus',6.4,-52.7,-0.7],['Arcturus',14.26,19.1,-0.05],
    ['Vega',18.62,38.78,0.03],['Capella',5.27,46,0.08],['Rigel',5.24,-8.2,0.13],
    ['Betelgeuse',5.92,7.4,0.5],['Altair',19.85,8.9,0.76],['Polaris',2.53,89.26,1.98]
  ];

  stars.forEach(s=>{
    const m=new THREE.SpriteMaterial({map:t});
    const sp=new THREE.Sprite(m);
    const p=vec(s[1],s[2]); sp.position.copy(p);
    sp.scale.setScalar((3-s[3])*2);
    sky.add(sp);
    objects.push({name:s[0],pos:p});
    label(s[0],p);
  });
}

function createSunMoon(){
  const d=new Date(); const day=(d-Date.UTC(d.getFullYear(),0,0))/86400000;
  const ra=(day/365.25)*24; const dec=23.44*Math.sin(day/365.25*2*Math.PI);

  const sun=new THREE.Mesh(new THREE.SphereGeometry(14,32,32),new THREE.MeshBasicMaterial({color:0xffdd66}));
  sun.position.copy(vec(ra,dec,420)); sky.add(sun);
  objects.push({name:'Sun',pos:sun.position}); label('Sun',sun.position);

  const moon=new THREE.Mesh(new THREE.SphereGeometry(9,32,32),new THREE.MeshLambertMaterial({color:0xddd}));
  moon.position.copy(vec((ra+12)%24,-dec,380)); sky.add(moon);
  objects.push({name:'Moon',pos:moon.position}); label('Moon',moon.position);
}

function label(text,pos){
  const d=document.createElement('div'); d.className='label'; d.textContent=text;
  document.body.appendChild(d); labels.push({d,pos});
}

/* ---------- SENSORS ---------- */
document.getElementById('go').onclick=async()=>{
  if(DeviceOrientationEvent?.requestPermission){ await DeviceOrientationEvent.requestPermission(); }
  navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude; lon=p.coords.longitude; alignSky();});
  window.addEventListener('deviceorientation',orient);
  document.getElementById('start').remove();
};

const qFix=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));
function orient(e){
  if(e.alpha==null) return;
  const q=new THREE.Quaternion().setFromEuler(new THREE.Euler(
    THREE.MathUtils.degToRad(e.beta),
    THREE.MathUtils.degToRad(e.alpha),
    -THREE.MathUtils.degToRad(e.gamma),'YXZ'));
  camera.quaternion.copy(q).multiply(qFix);
}

/* ---------- SEARCH ---------- */
const box=document.getElementById('results');
document.getElementById('search').oninput=e=>{
  box.innerHTML=''; const v=e.target.value.toLowerCase();
  if(v.length<2){box.style.display='none';return}
  objects.filter(o=>o.name.toLowerCase().includes(v)).forEach(o=>{
    const d=document.createElement('div'); d.className='result'; d.textContent=o.name;
    d.onclick=()=>{target=o; box.style.display='none'};
    box.appendChild(d);
  }); box.style.display='block';
};

/* ---------- LOOP ---------- */
function animate(){
  requestAnimationFrame(animate);

  labels.forEach(l=>{
    const v=l.pos.clone().applyEuler(sky.rotation).project(camera);
    if(v.z<1){
      l.d.style.display='block';
      l.d.style.transform=`translate(${(v.x*.5+.5)*innerWidth}px,${(-v.y*.5+.5)*innerHeight}px)`;
    }else l.d.style.display='none';
  });

  if(target){
    const v=target.pos.clone().applyEuler(sky.rotation).project(camera);
    const t=document.getElementById('target'); const a=document.getElementById('arrow');
    if(v.z<1){
      t.style.display='block'; a.style.display='none';
      t.style.left=(v.x*.5+.5)*innerWidth+'px';
      t.style.top=(-v.y*.5+.5)*innerHeight+'px';
    }else{
      t.style.display='none'; a.style.display='block';
      const dir=target.pos.clone().applyQuaternion(camera.quaternion.clone().invert());
      a.style.left='50%'; a.style.top='50%';
      a.style.transform=`translate(-50%,-50%) rotate(${Math.atan2(dir.y,dir.x)-Math.PI/2}rad)`;
    }
  }

  // Compass
  const f=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
  const az=Math.atan2(f.x,f.z);
  document.getElementById('needle').style.transform=`rotate(${az}rad)`;

  renderer.render(scene,camera);
}
</script>
</body>
</html>
