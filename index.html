<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Starry Night Ultimate</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0');

        :root {
            --glass-bg: rgba(20, 20, 30, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-blur: blur(12px);
            --primary: #D0BCFF;
            --accent: #4F378B;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000; /* Fallback */
            font-family: 'Roboto', sans-serif;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* The 3D Canvas */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Explicitly set z-index */
            display: block;
        }

        /* UI Layer - sits on top of Canvas */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* Above canvas */
            pointer-events: none; /* Allow clicks to pass through to 3D */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 16px;
            box-sizing: border-box;
        }

        /* Enable pointer events for actual buttons */
        .interactive {
            pointer-events: auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pill {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* Bottom Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .info-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 16px;
            max-width: 60%;
            transform: translateY(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .info-card.show {
            transform: translateY(0);
        }

        .info-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 4px 0;
        }

        .info-desc {
            font-size: 0.8rem;
            color: #ccc;
            line-height: 1.3;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fab {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: var(--accent);
            color: var(--primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        
        .fab:active { transform: scale(0.9); }

        /* Start Screen Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s;
        }
        
        .start-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: white;
            color: black;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
        }
    </style>

    <!-- Import Map for Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/"
        }
      }
    </script>
</head>
<body>

    <!-- Loader -->
    <div id="loader">
        <h1 style="font-weight: 100; letter-spacing: 2px;">STARRY NIGHT</h1>
        <p style="color: #666;">Rendering Universe...</p>
        <button class="start-btn interactive" id="btn-start">ENTER</button>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <div class="header interactive">
            <div class="pill">
                <span class="material-symbols-rounded">rocket_launch</span>
                <span>Starry Night</span>
            </div>
            <div class="pill">
                <span id="clock" style="font-family: monospace;">00:00</span>
            </div>
        </div>

        <div class="controls">
            <div class="info-card interactive" id="info-panel">
                <h3 class="info-name" id="p-name">Earth</h3>
                <div class="info-desc" id="p-desc">Our home planet.</div>
            </div>

            <div class="btn-group interactive">
                <button class="fab" id="btn-gyro"><span class="material-symbols-rounded">screen_rotation</span></button>
                <button class="fab" id="btn-reset"><span class="material-symbols-rounded">center_focus_weak</span></button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { DeviceOrientationControls } from 'three/addons/controls/DeviceOrientationControls.js';

        // --- Config ---
        const SETTINGS = {
            starCount: 6000,
            galaxyParticles: 4000,
            simSpeed: 0.2
        };

        let scene, camera, renderer, controls, gyroControls;
        let isGyro = false;
        let objects = []; // For raycasting
        let animatedObjects = []; // For orbit animation
        let raycaster, mouse;
        
        const loader = document.getElementById('loader');
        const startBtn = document.getElementById('btn-start');
        const infoPanel = document.getElementById('info-panel');
        const pName = document.getElementById('p-name');
        const pDesc = document.getElementById('p-desc');

        // Planet Data (Visual Scale)
        const planets = [
            { name: "Mercury", color: 0x999999, dist: 30, size: 2, speed: 0.04, desc: "Smallest planet." },
            { name: "Venus",   color: 0xe6b875, dist: 50, size: 5, speed: 0.02, desc: "Runaway greenhouse effect." },
            { name: "Earth",   color: 0x2244ff, dist: 80, size: 5.5, speed: 0.012, desc: "Supports life.", hasMoon: true },
            { name: "Mars",    color: 0xff3300, dist: 110, size: 3, speed: 0.008, desc: "The Red Planet." },
            { name: "Jupiter", color: 0xd9a066, dist: 180, size: 16, speed: 0.004, desc: "Gas giant.", hasMoon: true },
            { name: "Saturn",  color: 0xe3d2b4, dist: 260, size: 14, speed: 0.003, desc: "Has rings.", hasRings: true },
            { name: "Uranus",  color: 0xaaddff, dist: 340, size: 9, speed: 0.002, desc: "Ice giant." },
            { name: "Neptune", color: 0x3333ff, dist: 400, size: 8, speed: 0.001, desc: "Windiest planet." }
        ];

        startBtn.addEventListener('click', () => {
            loader.style.opacity = 0;
            setTimeout(() => loader.style.display = 'none', 800);
            init();
        });

        // Update clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        function init() {
            // 1. Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.0005); // Deep space fog

            // 2. Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 5000);
            camera.position.set(0, 60, 250);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // Very important: renderOrder
            document.body.appendChild(renderer.domElement);

            // 4. Lights (Make it bright enough!)
            const ambientLight = new THREE.AmbientLight(0x555555); // Base illumination
            scene.add(ambientLight);

            const sunLight = new THREE.PointLight(0xffffff, 2.5, 1000); // The Sun
            sunLight.position.set(0,0,0);
            scene.add(sunLight);

            // 5. Create Objects
            createSun();
            createStars();
            createGalaxy();
            createPlanets();
            createAsteroidBelt();

            // 6. Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxDistance = 1000;

            gyroControls = new DeviceOrientationControls(camera);
            gyroControls.enabled = false;

            // 7. Raycaster
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onResize);
            window.addEventListener('pointerdown', onPointerDown);

            // Start Loop
            renderer.setAnimationLoop(animate);
        }

        // --- Object Creation Functions ---

        function createSun() {
            // Core
            const geometry = new THREE.SphereGeometry(15, 32, 32);
            const material = new THREE.MeshBasicMaterial({ color: 0xFFDD00 }); // Basic material glows self-illuminated
            const sun = new THREE.Mesh(geometry, material);
            sun.userData = { name: "The Sun", desc: "Type G Yellow Dwarf Star." };
            objects.push(sun);
            scene.add(sun);

            // Glow Halo (Sprite)
            const spriteMat = new THREE.SpriteMaterial({ 
                color: 0xFFAA00, 
                blending: THREE.AdditiveBlending 
            });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.scale.set(60, 60, 1);
            scene.add(sprite);
        }

        function createPlanets() {
            planets.forEach(p => {
                const group = new THREE.Group(); // Holds the planet and its rotation
                scene.add(group);

                // Planet Mesh
                const geo = new THREE.SphereGeometry(p.size, 32, 32);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: p.color,
                    roughness: 0.7,
                    metalness: 0.1
                });
                const mesh = new THREE.Mesh(geo, mat);
                
                // Initial placement
                const angle = Math.random() * Math.PI * 2;
                mesh.position.set(Math.cos(angle) * p.dist, 0, Math.sin(angle) * p.dist);

                // Add data for raycasting and animation
                mesh.userData = { 
                    name: p.name, desc: p.desc, 
                    dist: p.dist, angle: angle, speed: p.speed 
                };
                
                group.add(mesh);
                objects.push(mesh);
                animatedObjects.push(mesh); // Add to animation loop

                // Orbit Trail (Visual Line)
                const trailGeo = new THREE.RingGeometry(p.dist - 0.2, p.dist + 0.2, 64);
                const trailMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0.1 });
                const trail = new THREE.Mesh(trailGeo, trailMat);
                trail.rotation.x = Math.PI / 2;
                scene.add(trail);

                // --- Extras (Moons, Rings) ---
                
                // Rings (Saturn)
                if (p.hasRings) {
                    const ringGeo = new THREE.RingGeometry(p.size + 2, p.size + 10, 32);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0xaa9988, side: THREE.DoubleSide, transparent: true, opacity: 0.7 });
                    const rings = new THREE.Mesh(ringGeo, ringMat);
                    rings.rotation.x = Math.PI / 1.8; // Tilt
                    mesh.add(rings);
                }

                // Earth Extras (Moon + Satellite)
                if (p.name === "Earth") {
                    // Moon
                    const moonGeo = new THREE.SphereGeometry(1.5, 16, 16);
                    const moonMat = new THREE.MeshStandardMaterial({ color: 0xcccccc });
                    const moon = new THREE.Mesh(moonGeo, moonMat);
                    moon.position.set(10, 0, 0);
                    mesh.add(moon); // Add to Earth mesh so it moves with Earth
                    
                    // Simple Satellite
                    const satGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                    const satMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const sat = new THREE.Mesh(satGeo, satMat);
                    sat.position.set(0, 7, 0); // Polar orbit position
                    mesh.add(sat);

                    // Animation data for Moon/Sat embedded in mesh
                    mesh.userData.hasExtras = true;
                    mesh.userData.extras = { moon, sat };
                }
            });
        }

        function createAsteroidBelt() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            
            for(let i=0; i<1500; i++) {
                const angle = Math.random() * Math.PI * 2;
                // Belt between Mars(110) and Jupiter(180) -> approx 140-160
                const r = 130 + Math.random() * 30; 
                const x = Math.cos(angle) * r;
                const y = (Math.random() - 0.5) * 15; // Vertical spread
                const z = Math.sin(angle) * r;
                vertices.push(x, y, z);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0x888888, size: 1.2 });
            const belt = new THREE.Points(geometry, material);
            scene.add(belt);
            // Add slight rotation reference
            belt.userData = { isBelt: true, speed: 0.0005 };
            animatedObjects.push(belt);
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for (let i = 0; i < SETTINGS.starCount; i++) {
                const r = 500 + Math.random() * 1500;
                const theta = 2 * Math.PI * Math.random();
                const phi = Math.acos(2 * Math.random() - 1);
                pos.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 2, sizeAttenuation: false }); // False makes them visible at distance
            const stars = new THREE.Points(geo, mat);
            scene.add(stars);
        }

        function createGalaxy() {
            // Milky Way visual (Spiral of particles)
            const geo = new THREE.BufferGeometry();
            const pos = [];
            const colors = [];
            const color1 = new THREE.Color(0x8A2BE2); // Violet
            const color2 = new THREE.Color(0x00BFFF); // Blue

            for(let i=0; i < SETTINGS.galaxyParticles; i++) {
                // Spiral Math
                const angle = i * 0.005; 
                const radius = i * 0.15 + 400; // Far out
                const spread = (Math.random() - 0.5) * 100;
                
                const x = Math.cos(angle) * radius + (Math.random()-0.5)*50;
                const z = Math.sin(angle) * radius + (Math.random()-0.5)*50;
                const y = (Math.random() - 0.5) * 40;

                pos.push(x, y, z);

                // Mix colors
                const mixedColor = color1.clone().lerp(color2, Math.random());
                colors.push(mixedColor.r, mixedColor.g, mixedColor.b);
            }

            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const mat = new THREE.PointsMaterial({ size: 3, vertexColors: true, transparent: true, opacity: 0.6 });
            const galaxy = new THREE.Points(geo, mat);
            scene.add(galaxy);
            
            // Rotate the galaxy slowly
            galaxy.userData = { isGalaxy: true, speed: 0.0002 };
            animatedObjects.push(galaxy);
        }

        // --- Interaction & Animation ---

        function onPointerDown(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects);

            if (intersects.length > 0) {
                const target = intersects[0].object;
                showInfo(target.userData.name, target.userData.desc);
                // Optional: Snap camera to look at object? 
                // controls.target.copy(target.position);
            } else {
                hideInfo();
            }
        }

        function showInfo(name, desc) {
            pName.innerText = name;
            pDesc.innerText = desc;
            infoPanel.classList.add('show');
        }

        function hideInfo() {
            infoPanel.classList.remove('show');
        }

        function animate() {
            // 1. Planet Orbits
            animatedObjects.forEach(obj => {
                if (obj.userData.speed) {
                    if (obj.userData.isBelt || obj.userData.isGalaxy) {
                        // Simple Rotation for belt/galaxy
                        obj.rotation.y += obj.userData.speed;
                    } else {
                        // Orbital mechanics
                        obj.userData.angle += obj.userData.speed * SETTINGS.simSpeed;
                        obj.position.x = Math.cos(obj.userData.angle) * obj.userData.dist;
                        obj.position.z = Math.sin(obj.userData.angle) * obj.userData.dist;
                        obj.rotation.y += 0.02; // Self rotation

                        // Extras Animation (Moon orbit)
                        if(obj.userData.hasExtras) {
                            const time = Date.now() * 0.001;
                            // Moon orbit around Earth
                            obj.userData.extras.moon.position.x = Math.cos(time) * 10;
                            obj.userData.extras.moon.position.z = Math.sin(time) * 10;
                            // Satellite tumbling
                            obj.userData.extras.sat.rotation.x += 0.05;
                            obj.userData.extras.sat.rotation.y += 0.05;
                        }
                    }
                }
            });

            // 2. Controls
            if (isGyro && gyroControls.enabled) {
                gyroControls.update();
            } else {
                controls.update();
            }

            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Buttons ---
        document.getElementById('btn-reset').addEventListener('click', () => {
            controls.reset();
            camera.position.set(0, 60, 250);
            camera.lookAt(0,0,0);
            isGyro = false;
            gyroControls.enabled = false;
            controls.enabled = true;
            hideInfo();
        });

        document.getElementById('btn-gyro').addEventListener('click', async () => {
            if (!isGyro) {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') enableGyro();
                } else {
                    enableGyro();
                }
            } else {
                disableGyro();
            }
        });

        function enableGyro() {
            isGyro = true;
            controls.enabled = false;
            gyroControls.enabled = true;
            showInfo("AR Mode", "Move device to explore.");
        }

        function disableGyro() {
            isGyro = false;
            gyroControls.enabled = false;
            controls.enabled = true;
        }

    </script>
</body>
</html>
