<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Starry Night OS</title>

    <!-- Error Handler (Runs before anything else) -->
    <script>
        window.addEventListener('error', function(e) {
            const el = document.getElementById('error-log');
            if(el) {
                el.style.display = 'block';
                el.innerHTML += `<br>ERROR: ${e.message}`;
            }
        });
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon: #00f3ff;
            --glass: rgba(10, 15, 25, 0.9);
            --border: rgba(255, 255, 255, 0.15);
        }

        /* Core Layout */
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Rajdhani', sans-serif; color: white;
            user-select: none; -webkit-user-select: none;
            touch-action: none; /* Critical for touch drag */
        }

        /* 3D Viewport */
        #viewport { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; 
            background: radial-gradient(circle at bottom, #0f1525 0%, #000 100%);
        }

        /* UI Layer (Pass-through clicks) */
        #ui-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            pointer-events: none; /* THIS FIXES THE UI BLOCKING SENSORS */
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Interactive Elements (Capture clicks) */
        .interactive { pointer-events: auto !important; }

        /* Top Bar */
        .top-bar { padding: 20px; background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent); }
        .search-box { position: relative; max-width: 500px; margin: 0 auto; }
        
        input#search { 
            width: 100%; padding: 12px 20px; border-radius: 30px; 
            border: 1px solid var(--border); background: var(--glass);
            color: #fff; font-family: 'Rajdhani', sans-serif; font-size: 18px; 
            outline: none; backdrop-filter: blur(10px);
        }
        input#search:focus { border-color: var(--neon); box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }

        #results {
            position: absolute; top: 60px; left: 0; right: 0;
            background: rgba(5, 8, 12, 0.95); border: 1px solid var(--border);
            border-radius: 10px; max-height: 40vh; overflow-y: auto; display: none;
        }
        .result-row { 
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; 
            justify-content: space-between; align-items: center; 
        }
        .result-row:active { background: rgba(0, 243, 255, 0.2); }
        .res-type { font-size: 10px; border: 1px solid var(--neon); padding: 2px 5px; color: var(--neon); border-radius: 4px; }

        /* Bottom HUD */
        .bottom-bar { 
            padding: 20px; text-align: center; 
            background: linear-gradient(0deg, rgba(0,0,0,0.9), transparent); 
        }
        .compass-wrap { 
            width: 60px; height: 60px; margin: 0 auto; border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); position: relative;
        }
        .compass-n { position: absolute; top: -5px; color: var(--neon); font-weight: bold; }
        .status { font-size: 12px; color: #8899aa; margin-top: 10px; }

        /* Reticle */
        #reticle {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; border: 1px dashed rgba(255,255,255,0.5); 
            border-radius: 50%; opacity: 0; transition: opacity 0.3s;
        }
        #reticle.active { opacity: 1; border-color: var(--neon); box-shadow: 0 0 20px var(--neon); }
        
        #guide-arrow { 
            position: absolute; top: 50%; left: 50%; width: 0; height: 0; pointer-events: none; display: none; 
        }
        .arrow-shape {
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-bottom: 40px solid var(--neon); transform: translate(-50%, -150px);
            filter: drop-shadow(0 0 10px var(--neon));
        }

        /* Splash Screen */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        h1 { font-family: 'Exo 2', sans-serif; font-size: 40px; margin: 0; color: white; letter-spacing: 5px; }
        p { color: #888; margin-bottom: 40px; }
        
        button.start-btn {
            background: transparent; color: var(--neon); border: 2px solid var(--neon);
            padding: 15px 40px; font-size: 18px; font-family: 'Rajdhani', sans-serif; font-weight: bold;
            border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); transition: 0.2s;
        }
        button.start-btn:active { background: var(--neon); color: black; transform: scale(0.95); }

        #error-log { 
            color: #ff3333; font-family: monospace; font-size: 10px; 
            max-width: 80%; text-align: left; margin-top: 20px; display: none; 
            border: 1px solid #333; padding: 10px; background: #111;
        }

    </style>
</head>
<body>

    <!-- Loading / Start Screen -->
    <div id="splash" class="interactive">
        <h1>STARRY NIGHT</h1>
        <p>AR SYSTEM OFFLINE</p>
        <button class="start-btn" id="init-btn">INITIALIZE SYSTEM</button>
        <div id="error-log">Logs:</div>
    </div>

    <!-- Main UI -->
    <div id="ui-layer">
        <!-- Top -->
        <div class="top-bar interactive">
            <div class="search-box">
                <input type="text" id="search" placeholder="SEARCH DATABASE..." autocomplete="off">
                <div id="results"></div>
            </div>
        </div>

        <!-- Center Overlay -->
        <div id="reticle"></div>
        <div id="guide-arrow"><div class="arrow-shape"></div></div>

        <!-- Bottom -->
        <div class="bottom-bar interactive">
            <div class="compass-wrap" id="compass-ui">
                <div style="width:2px; height:10px; background:white; position:absolute; top:0;"></div>
                <div class="compass-n">N</div>
            </div>
            <div class="status" id="gps-status">SENSORS STANDBY</div>
        </div>
    </div>

    <div id="viewport"></div>

    <!-- Modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "astronomy-engine": "https://unpkg.com/astronomy-engine@2.0.0/esm/index.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import * as Astronomy from 'astronomy-engine';

        // --- GLOBAL VARIABLES ---
        const state = {
            isRunning: false,
            lat: 0,
            lon: 0,
            target: null,
            manual: { active: false, x: 0, y: 0, yaw: 0, pitch: 0 }
        };

        let scene, camera, renderer;
        let starGroup, solarGroup, worldGroup;
        const celestialDB = [];

        // --- INITIALIZATION ---
        const initBtn = document.getElementById('init-btn');
        const splash = document.getElementById('splash');

        initBtn.onclick = function() {
            try {
                // 1. Hide Splash
                splash.style.opacity = 0;
                setTimeout(() => splash.style.display = 'none', 500);
                
                // 2. Start Systems
                initThreeJS();
                enableSensors();
                state.isRunning = true;
            } catch (err) {
                alert("Init Failed: " + err.message);
                document.getElementById('error-log').style.display = 'block';
                document.getElementById('error-log').innerText += "\nInit Err: " + err.message;
            }
        };

        async function enableSensors() {
            // iOS Permission Check
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    await DeviceOrientationEvent.requestPermission();
                } catch(e) { console.log(e); }
            }
            window.addEventListener('deviceorientation', handleOrientation);

            // GPS
            document.getElementById('gps-status').innerText = "ACQUIRING ORBIT...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        state.lat = pos.coords.latitude;
                        state.lon = pos.coords.longitude;
                        document.getElementById('gps-status').innerText = `LAT: ${state.lat.toFixed(2)} | LON: ${state.lon.toFixed(2)}`;
                        updateCelestialPositions(); 
                    },
                    (err) => {
                        document.getElementById('gps-status').innerText = "GPS FAILURE - MANUAL MODE";
                        updateCelestialPositions();
                    }
                );
            } else {
                updateCelestialPositions();
            }
        }

        // --- 3D ENGINE ---
        function initThreeJS() {
            const container = document.getElementById('viewport');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050510, 0.0006);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            // Layers
            worldGroup = new THREE.Group(); scene.add(worldGroup);
            starGroup = new THREE.Group(); worldGroup.add(starGroup);
            solarGroup = new THREE.Group(); worldGroup.add(solarGroup);

            // Grid
            const grid = new THREE.PolarGridHelper(1000, 24, 8, 64, 0x112233, 0x000000);
            scene.add(grid);

            // Content
            generateContent();
            setupControls();
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- CONTENT GENERATION ---
        function createLabel(text, color, scale=1) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const fs = 32;
            ctx.font = `bold ${fs}px 'Rajdhani', sans-serif`;
            const w = ctx.measureText(text).width;
            canvas.width = w + 20; canvas.height = fs + 20;
            ctx.fillStyle = color;
            ctx.font = `bold ${fs}px 'Rajdhani', sans-serif`;
            ctx.shadowColor = 'black'; ctx.shadowBlur = 4;
            ctx.fillText(text, 10, fs-5);

            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthTest: false });
            const sprite = new THREE.Sprite(mat);
            sprite.center.set(0.5, 1.2); // Text below object
            const s = 0.5 * (fs/10) * scale;
            sprite.scale.set(s * (canvas.width/canvas.height), s, 1);
            return sprite;
        }

        function getVec(ra, dec) {
            const r = 1000;
            const phi = ra * 15 * (Math.PI/180);
            const theta = dec * (Math.PI/180);
            const x = r * Math.cos(theta) * Math.sin(phi);
            const y = r * Math.sin(theta);
            const z = r * Math.cos(theta) * Math.cos(phi);
            return new THREE.Vector3(-x, y, -z);
        }

        function generateContent() {
            // Star Texture
            const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
            const ctx = cvs.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'white'); g.addColorStop(0.5,'rgba(255,255,255,0.5)'); g.addColorStop(1,'transparent');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            const tex = new THREE.CanvasTexture(cvs);

            // Catalog
            const catalog = [
                ["Sirius",6.75,-16.7,"#aaddff",1.5], ["Canopus",6.4,-52.7,"#ffffff",1.4], ["Arcturus",14.26,19.1,"#ffccaa",1.3],
                ["Vega",18.62,38.8,"#aaddff",1.3], ["Capella",5.27,46.0,"#ffffaa",1.3], ["Rigel",5.24,-8.2,"#ccccff",1.3],
                ["Procyon",7.65,5.2,"#ffffff",1.2], ["Betelgeuse",5.92,7.4,"#ff8866",1.4], ["Altair",19.85,8.9,"#ffffff",1.2],
                ["Aldebaran",4.6,16.5,"#ffaa55",1.2], ["Antares",16.49,-26.4,"#ff4433",1.2], ["Spica",13.42,-11.2,"#aaaaff",1.2],
                ["Polaris",2.53,89.3,"#ffffdd",1.2], ["Andromeda Galaxy",0.71,41.26,"#ddeeFF",3.0,"GALAXY"],
                ["Orion Nebula",5.58,-5.39,"#ffccff",3.0,"NEBULA"], ["Pleiades",3.78,24.1,"#aabbff",2.5,"CLUSTER"]
            ];

            catalog.forEach(item => {
                const [name, ra, dec, col, sz, type] = item;
                const pos = getVec(ra, dec);
                
                // Sprite
                const mat = new THREE.SpriteMaterial({ map: tex, color: col });
                const sprite = new THREE.Sprite(mat);
                sprite.position.copy(pos);
                sprite.scale.setScalar(20 * sz);
                starGroup.add(sprite);

                // Label
                const label = createLabel(name, col);
                label.position.copy(pos);
                starGroup.add(label);

                celestialDB.push({ name: name, type: type || "STAR", pos: pos, group: starGroup });
            });

            // Milky Way
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<3000; i++) {
                const r = 900;
                const a = Math.random() * Math.PI * 2;
                const h = (Math.random()-0.5) * 300;
                const v = new THREE.Vector3(r*Math.cos(a), h, r*Math.sin(a));
                v.applyAxisAngle(new THREE.Vector3(1,0,0), 60 * (Math.PI/180));
                pos.push(v.x, v.y, v.z);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mw = new THREE.Points(geo, new THREE.PointsMaterial({color: 0x665588, size: 3, transparent:true, opacity:0.2, blending: THREE.AdditiveBlending}));
            starGroup.add(mw);
        }

        function updateCelestialPositions() {
            const date = new Date();
            const observer = new Astronomy.Observer(state.lat, state.lon, 0);
            
            while(solarGroup.children.length) solarGroup.remove(solarGroup.children[0]);

            const planets = [
                {k:"Sun", c:"#ffaa00", s:80}, {k:"Moon", c:"#eeeeee", s:60},
                {k:"Mars", c:"#ff5533", s:40}, {k:"Jupiter", c:"#ffcc99", s:60},
                {k:"Saturn", c:"#eebb88", s:50}, {k:"Venus", c:"#ffffff", s:45}
            ];

            planets.forEach(p => {
                const body = Astronomy.Body[p.k];
                const eq = Astronomy.Equator(body, date, observer, true, true);
                const pos = getVec(eq.ra, eq.dec);

                const mesh = new THREE.Mesh(new THREE.SphereGeometry(1,16,16), new THREE.MeshBasicMaterial({color:p.c}));
                mesh.position.copy(pos);
                mesh.scale.setScalar(p.s/2);
                solarGroup.add(mesh);

                const lbl = createLabel(p.k, p.c);
                lbl.position.copy(pos);
                solarGroup.add(lbl);

                celestialDB.push({ name: p.k, type: p.k==="Sun"?"STAR":p.k==="Moon"?"MOON":"PLANET", pos: pos, group: solarGroup });
            });

            // Time & Lat Rotation
            const gst = Astronomy.SiderealTime(date);
            const lst = gst + state.lon/15.0;
            const rotY = -(lst * 15 * Math.PI/180) - Math.PI/2;
            
            starGroup.rotation.y = rotY;
            solarGroup.rotation.y = rotY;
            worldGroup.rotation.x = (90 - state.lat) * (Math.PI/180);
        }

        // --- CONTROLS ---

        function setupControls() {
            const el = document.getElementById('viewport');
            
            const start = (x,y) => {
                state.manual.active = true;
                state.manual.x = x;
                state.manual.y = y;
            };
            const move = (x,y) => {
                if(!state.manual.active) return;
                const dx = x - state.manual.x;
                const dy = y - state.manual.y;
                state.manual.yaw += dx * 0.005;
                state.manual.pitch += dy * 0.005;
                state.manual.x = x;
                state.manual.y = y;
            };
            const end = () => state.manual.active = false;

            // Touch
            el.addEventListener('touchstart', e => start(e.touches[0].clientX, e.touches[0].clientY));
            window.addEventListener('touchmove', e => move(e.touches[0].clientX, e.touches[0].clientY));
            window.addEventListener('touchend', end);
            
            // Mouse
            el.addEventListener('mousedown', e => start(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
            window.addEventListener('mouseup', end);
        }

        const finalQ = new THREE.Quaternion();
        const deviceEuler = new THREE.Euler();
        const screenQ = new THREE.Quaternion();
        const worldQ = new THREE.Quaternion(-Math.sqrt(0.5), 0, 0, Math.sqrt(0.5)); 
        let sensorActive = false;

        function handleOrientation(e) {
            if(e.alpha === null) return;
            sensorActive = true;
            
            const alpha = THREE.MathUtils.degToRad(e.alpha);
            const beta = THREE.MathUtils.degToRad(e.beta);
            const gamma = THREE.MathUtils.degToRad(e.gamma);
            const orient = (window.orientation || 0) * THREE.MathUtils.DEG2RAD;

            deviceEuler.set(beta, alpha, -gamma, 'YXZ');
            finalQ.setFromEuler(deviceEuler);
            finalQ.multiply(worldQ);
            
            const minusHalfAngle = -orient / 2;
            screenQ.set(0, 0, Math.sin(minusHalfAngle), Math.cos(minusHalfAngle));
            finalQ.multiply(screenQ);

            document.getElementById('compass-ui').style.transform = `rotate(${e.alpha}deg)`;
        }

        // --- SEARCH ---
        const sInput = document.getElementById('search');
        const sRes = document.getElementById('results');

        sInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            sRes.innerHTML = '';
            if(val.length < 2) { sRes.style.display='none'; return; }

            const hits = celestialDB.filter(x => x.name.toLowerCase().includes(val));
            const uniqueHits = [...new Map(hits.map(item => [item.name, item])).values()];

            if(uniqueHits.length > 0) {
                sRes.style.display = 'block';
                uniqueHits.slice(0, 5).forEach(hit => {
                    const row = document.createElement('div');
                    row.className = 'result-row interactive';
                    row.innerHTML = `<span style="font-weight:bold">${hit.name}</span><span class="res-type">${hit.type}</span>`;
                    row.onclick = () => {
                        state.target = hit;
                        sInput.value = hit.name;
                        sRes.style.display = 'none';
                        document.getElementById('reticle').classList.add('active');
                    };
                    sRes.appendChild(row);
                });
            } else {
                sRes.style.display = 'none';
            }
        });

        // --- ANIMATION ---
        function animate() {
            requestAnimationFrame(animate);

            if(sensorActive && !state.manual.active) {
                camera.quaternion.slerp(finalQ, 0.1);
            } else {
                camera.rotation.order = 'YXZ';
                camera.rotation.y = state.manual.yaw;
                camera.rotation.x = state.manual.pitch;
            }

            if(state.target) {
                const tPos = state.target.pos.clone();
                tPos.applyEuler(state.target.group.rotation);
                tPos.applyEuler(worldGroup.rotation);
                tPos.project(camera);

                const x = (tPos.x * .5 + .5) * window.innerWidth;
                const y = -(tPos.y * .5 - .5) * window.innerHeight;

                const reticle = document.getElementById('reticle');
                const arrow = document.getElementById('guide-arrow');

                if(tPos.z < 1) {
                    if(x>0 && x<window.innerWidth && y>0 && y<window.innerHeight) {
                        arrow.style.display='none';
                        reticle.style.display='block';
                        reticle.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                    } else {
                        reticle.style.display='none';
                        arrow.style.display='block';
                        pointArrow(x,y);
                    }
                } else {
                    reticle.style.display='none';
                    arrow.style.display='block';
                    pointArrow(x,y,true);
                }
            }

            renderer.render(scene, camera);
        }

        function pointArrow(tx, ty, behind=false) {
            const cx = window.innerWidth/2;
            const cy = window.innerHeight/2;
            let dx = tx - cx;
            let dy = ty - cy;
            if(behind) { dx = -dx; dy = -dy; }
            const ang = Math.atan2(dy, dx);
            const r = Math.min(cx, cy) - 60;
            const fx = cx + Math.cos(ang)*r;
            const fy = cy + Math.sin(ang)*r;
            document.getElementById('guide-arrow').style.transform = `translate(${fx}px, ${fy}px) rotate(${ang + Math.PI/2}rad)`;
        }

    </script>
</body>
</html>
